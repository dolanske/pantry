{"version":3,"file":"index.js","sources":["../src/link.ts","../src/pantry.ts"],"sourcesContent":["import type { Children } from '@dolanske/cascade'\r\nimport { a } from '@dolanske/cascade'\r\nimport type { NavigateOptions } from '@dolanske/crumbs'\r\nimport { navigate } from '@dolanske/crumbs'\r\n\r\nexport function Link(href: string, children: Children<object>, options?: NavigateOptions) {\r\n  return a(children).setup((ctx) => {\r\n    ctx.attr('href', href)\r\n    ctx.click((event) => {\r\n      event.preventDefault()\r\n      navigate(href, options)\r\n    })\r\n  })\r\n}\r\n","import type { Route as CrumbRoute, Router as CrumbRouter } from '@dolanske/crumbs'\r\nimport { defineRouter, onRouteError, onRouteResolve } from '@dolanske/crumbs'\r\nimport { Component } from '@dolanske/cascade'\r\n\r\n/**\r\n * TODO\r\n *\r\n * [] Add loaderFallback to Route interface\r\n * [] Rename fallback in Route interface to errorFallback\r\n */\r\n\r\nfunction noop() { }\r\n\r\nexport type PropType<LoaderData, ComponentProps extends object = object> = LoaderProps<LoaderData> & ComponentProps\r\n\r\ntype BaseRouteProps = PropType<object, object> | object\r\n\r\nexport interface Route {\r\n  component: Component<any>\r\n  loader?: CrumbRoute['loader']\r\n  title?: CrumbRoute['title']\r\n  default?: CrumbRoute['default']\r\n  fallback?: Component<any>\r\n}\r\n\r\nexport interface LoaderProps<D> {\r\n  $params: Record<string, string>\r\n  $data: D\r\n}\r\n\r\ntype Router = Record<string, Route | Component<BaseRouteProps>>\r\n\r\nexport function createApp(routes: Router) {\r\n  const RouterViews: Record<string, Component<BaseRouteProps>> = {}\r\n  const RouteFallbacks: Record<string, Component<BaseRouteProps>> = {}\r\n  const CrumbsRouter: CrumbRouter = {}\r\n\r\n  // Serialize base application routes into what crumbs can consume\r\n  for (const [path, route] of Object.entries(routes)) {\r\n    // This router is generic, built for HTML, so within Cascade, we just need to\r\n    // mimic the router paths with an emty div as a router wrapper\r\n    const html = '<div route-boundary>'\r\n    if (route instanceof Component) {\r\n      RouterViews[path] = route\r\n      CrumbsRouter[path] = {\r\n        html,\r\n      }\r\n    }\r\n    else {\r\n      const { loader, title, default: _default, fallback, component } = route\r\n      RouterViews[path] = component\r\n      CrumbsRouter[path] = {\r\n        loader,\r\n        title,\r\n        default: _default,\r\n        html,\r\n      }\r\n\r\n      if (fallback)\r\n        RouteFallbacks[path] = fallback\r\n    }\r\n  }\r\n\r\n  const router = defineRouter(CrumbsRouter)\r\n\r\n  // Store stopper between `run` and `stop` handlers\r\n  let onResolveRelease = noop\r\n  let onErrorRelease = noop\r\n\r\n  let prevView: Component<BaseRouteProps> | undefined\r\n  let prevFallback: Component<BaseRouteProps> | undefined\r\n  let globalErrorFallback: Component<BaseRouteProps> | undefined\r\n\r\n  return {\r\n    run: (selector: string) => {\r\n      // Watch for when new route is navigated into and then render Cascade app into its wrapper\r\n      onResolveRelease = onRouteResolve((route) => {\r\n        if (prevView) {\r\n          prevView.el.replaceChildren()\r\n          prevView.destroy()\r\n        }\r\n\r\n        const newView = RouterViews[route.path]\r\n        if (newView) {\r\n          const view = newView.clone()\r\n          // If route contained a loader, set the data as a prop\r\n          view.props({\r\n            $data: route.data,\r\n            $params: route.params,\r\n          })\r\n\r\n          view.mount('[route-boundary]')\r\n          prevView = view\r\n        }\r\n      })\r\n\r\n      onErrorRelease = onRouteError((route, error) => {\r\n        let newFallback: Component<BaseRouteProps> | undefined\r\n\r\n        if (prevFallback) {\r\n          prevFallback.el.replaceChildren()\r\n          prevFallback.destroy()\r\n        }\r\n\r\n        if (!route) {\r\n          console.warn('Attempted to navigate to a route that does not exist')\r\n          console.error(error)\r\n          newFallback = globalErrorFallback\r\n        }\r\n        else {\r\n          newFallback = RouteFallbacks[route.path]\r\n        }\r\n\r\n        if (newFallback) {\r\n          const fallback = newFallback.clone()\r\n\r\n          fallback.mount('route-boundary')\r\n          prevFallback = fallback\r\n        }\r\n      })\r\n\r\n      router.run(selector)\r\n    },\r\n    stop: () => {\r\n      router.stop()\r\n      onResolveRelease()\r\n      onErrorRelease()\r\n      if (prevView)\r\n        prevView.destroy()\r\n      if (prevFallback)\r\n        prevFallback.destroy()\r\n    },\r\n    errorFallback: (component: Component<BaseRouteProps>) => {\r\n      globalErrorFallback = component\r\n    },\r\n  }\r\n}\r\n"],"names":["Link","href","children","options","a","ctx","event","navigate","noop","createApp","routes","RouterViews","RouteFallbacks","CrumbsRouter","path","route","html","Component","loader","title","_default","fallback","component","router","defineRouter","onResolveRelease","onErrorRelease","prevView","prevFallback","globalErrorFallback","selector","onRouteResolve","newView","view","onRouteError","error","newFallback"],"mappings":";;AAKgB,SAAAA,EAAKC,GAAcC,GAA4BC,GAA2B;AACxF,SAAOC,EAAEF,CAAQ,EAAE,MAAM,CAACG,MAAQ;AAC5B,IAAAA,EAAA,KAAK,QAAQJ,CAAI,GACjBI,EAAA,MAAM,CAACC,MAAU;AACnB,MAAAA,EAAM,eAAe,GACrBC,EAASN,GAAME,CAAO;AAAA,IAAA,CACvB;AAAA,EAAA,CACF;AACH;ACFA,SAASK,IAAO;AAAE;AAqBX,SAASC,EAAUC,GAAgB;AACxC,QAAMC,IAAyD,CAAC,GAC1DC,IAA4D,CAAC,GAC7DC,IAA4B,CAAC;AAGnC,aAAW,CAACC,GAAMC,CAAK,KAAK,OAAO,QAAQL,CAAM,GAAG;AAGlD,UAAMM,IAAO;AACb,QAAID,aAAiBE;AACnB,MAAAN,EAAYG,CAAI,IAAIC,GACpBF,EAAaC,CAAI,IAAI;AAAA,QACnB,MAAAE;AAAA,MACF;AAAA,SAEG;AACH,YAAM,EAAE,QAAAE,GAAQ,OAAAC,GAAO,SAASC,GAAU,UAAAC,GAAU,WAAAC,MAAcP;AAClE,MAAAJ,EAAYG,CAAI,IAAIQ,GACpBT,EAAaC,CAAI,IAAI;AAAA,QACnB,QAAAI;AAAA,QACA,OAAAC;AAAA,QACA,SAASC;AAAA,QACT,MAAAJ;AAAA,MACF,GAEIK,MACFT,EAAeE,CAAI,IAAIO;AAAA,IAAA;AAAA,EAC3B;AAGI,QAAAE,IAASC,EAAaX,CAAY;AAGxC,MAAIY,IAAmBjB,GACnBkB,IAAiBlB,GAEjBmB,GACAC,GACAC;AAEG,SAAA;AAAA,IACL,KAAK,CAACC,MAAqB;AAEN,MAAAL,IAAAM,EAAe,CAAChB,MAAU;AAC3C,QAAIY,MACFA,EAAS,GAAG,gBAAgB,GAC5BA,EAAS,QAAQ;AAGb,cAAAK,IAAUrB,EAAYI,EAAM,IAAI;AACtC,YAAIiB,GAAS;AACL,gBAAAC,IAAOD,EAAQ,MAAM;AAE3B,UAAAC,EAAK,MAAM;AAAA,YACT,OAAOlB,EAAM;AAAA,YACb,SAASA,EAAM;AAAA,UAAA,CAChB,GAEDkB,EAAK,MAAM,kBAAkB,GAClBN,IAAAM;AAAA,QAAA;AAAA,MACb,CACD,GAEgBP,IAAAQ,EAAa,CAACnB,GAAOoB,MAAU;AAC1C,YAAAC;AAgBJ,YAdIR,MACFA,EAAa,GAAG,gBAAgB,GAChCA,EAAa,QAAQ,IAGlBb,IAMWqB,IAAAxB,EAAeG,EAAM,IAAI,KALvC,QAAQ,KAAK,sDAAsD,GACnE,QAAQ,MAAMoB,CAAK,GACLC,IAAAP,IAMZO,GAAa;AACT,gBAAAf,IAAWe,EAAY,MAAM;AAEnC,UAAAf,EAAS,MAAM,gBAAgB,GAChBO,IAAAP;AAAA,QAAA;AAAA,MACjB,CACD,GAEDE,EAAO,IAAIO,CAAQ;AAAA,IACrB;AAAA,IACA,MAAM,MAAM;AACV,MAAAP,EAAO,KAAK,GACKE,EAAA,GACFC,EAAA,GACXC,KACFA,EAAS,QAAQ,GACfC,KACFA,EAAa,QAAQ;AAAA,IACzB;AAAA,IACA,eAAe,CAACN,MAAyC;AACjC,MAAAO,IAAAP;AAAA,IAAA;AAAA,EAE1B;AACF;"}